<!DOCTYPE html>
<html lang="en">
    <head>
      <title>Kenzi Connor: Handling FormData and file inputs in Rust Wasm</title>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="content-type" content="text/html; charset=utf-8">

<!-- Enable responsiveness on mobile devices-->
<!-- viewport-fit=cover is to support iPhone X rounded corners and notch in landscape-->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, viewport-fit=cover">

  <link rel="icon" href="/assets/images/walle-female.svg">

<!-- CSS -->
<link rel="stylesheet" href="https://knz.ai/print.css" media="print">
<link rel="stylesheet" href="https://knz.ai/poole.css">
<link rel="stylesheet" href="https://knz.ai/hyde.css">
<link rel="stylesheet" href="https://knz.ai/styles.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
      <link rel="alternate" type="application/atom+xml" title="Kenzi Connor Atom Feed" href="https://knz.ai/atom.xml" />
      <link rel="alternate" type="application/rss+xml" title="Kenzi Connor RSS Feed" href="https://knz.ai/rss.xml" />
      
      
      
	<meta property="og:image" content="https://knz.ai/posts/wasm-file-form.png" />
	<meta property="og:title" content="Kenzi Connor: Handling FormData and file inputs in Rust Wasm">
	<meta property="og:description" content="Pull requests and example usage of yew, gloo, and web-sys">

    </head>
    <body class="theme-base-08 layout-reverse">
      <div class="sidebar">
        
          <div class="container sidebar-sticky">
  <ul class="sidebar-nav">
    <li class="sidebar-nav-item active">posts</li><li class="sidebar-nav-item">
      <a href="https:&#x2F;&#x2F;knz.ai&#x2F;projects&#x2F;" class=>projects</a></li><li class="sidebar-nav-item">
      <a href="https:&#x2F;&#x2F;knz.ai&#x2F;about&#x2F;" class=>about</a></li>
  <li class="sidebar-nav-item">
      <a href="https:&#x2F;&#x2F;knz.ai&#x2F;resume&#x2F;" class=>resume</a></li>

</ul>
  <div class="sidebar-about">
    
        <a href="https:&#x2F;&#x2F;knz.ai"><h1>Kenzi Connor</h1></a>
        
        <p class="lead">Staff Software Engineer - VP Engineering - Director of Engineering - CEO &amp; CTO</p>
        
    
  </div>
  <ul class="sidebar-nav">
      
      <li class="sidebar-nav-item"><a rel="me" href="https:&#x2F;&#x2F;github.com&#x2F;knzai">GitHub</a></li>
      
      <li class="sidebar-nav-item"><a rel="me" href="https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;knzai&#x2F;">LinkedIn</a></li>
      
      <li class="sidebar-nav-item"><a rel="me" href="mailto:site@knz.ai">site@knz.ai</a></li>
      
      <li class="sidebar-nav-item"><a rel="me" href="https:&#x2F;&#x2F;tech.lgbt&#x2F;@knzai">Mastadon</a></li>
      
  </ul>
</div>
        
      </div>
      <div class="content container">
        
	
<div class="breadcrumb-container">
    
    
      
      
        <a class="breadcrumb-path" href="https:&#x2F;&#x2F;knz.ai&#x2F;">knz.ai</a>
      
      <span class="breadcrumb-separator">></span>
    
      
      
        <a class="breadcrumb-path" href="https:&#x2F;&#x2F;knz.ai&#x2F;posts&#x2F;">posts</a>
      
      <span class="breadcrumb-separator">></span>
    
    
    
      wasm-file-form
    
</div>


	<div class="post wasm-file-form">
  
  
  <h2 class="post-title">
    <a href="https:&#x2F;&#x2F;knz.ai&#x2F;posts&#x2F;wasm-file-form&#x2F;" id="Handling FormData and file inputs in Rust Wasm">Handling FormData and file inputs in Rust Wasm</a>: <span class="post-description">Pull requests and example usage of yew, gloo, and web-sys</span>
  </h2>

  <span class="post-date">2024-07-20</span>
  
    <p>I submitted some <a href="https://github.com/knzai/yew/pulls">pull requests for additional examples</a> to the top level library I'm using for Rust Wasm, <a href="https://yew.rs/">yew</a>. Some of the underlying tech and libraries have advanced since most of the examples were created, and there wasn't a simple one for a very common use case: using a form with multiple fields, including a file-input selector.</p>
<p>Given there are a lot of PRs outstanding and the their CI is a bit b0rked, I don't know how likely it is they'll get pulled in, so I'll document here. Also, some of the answers apply to the underlying lbraries even if you aren't using yew, and it took some digging through reddit, code, examples, and finally Discord to find the simplest answers using the current state of all the pieces.</p>
<span id="continue-reading"></span><h3 id="simple-form">Simple form</h3>
<p>The <a href="https://github.com/knzai/yew/pull/3/files">primary access to form data</a> can be handled from <a href="https://crates.io/crates/web-sys">web-sys</a> directly. I'm using yew to build the html and handle the context and events and everything, but the yew events map to web-sys events, so either way it's useful:</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">use </span><span>web_sys::{FormData, HtmlFormElement};
</span><span style="color:#b48ead;">use </span><span>yew::prelude::*;
</span><span>...
</span><span>Msg::Submit(event) =&gt; {
</span><span>	event.</span><span style="color:#96b5b4;">prevent_default</span><span>();
</span><span>	</span><span style="color:#b48ead;">let</span><span> form: HtmlFormElement = event.</span><span style="color:#96b5b4;">target_unchecked_into</span><span>();
</span><span>	</span><span style="color:#b48ead;">let</span><span> form_data = FormData::new_with_form(&amp;form).</span><span style="color:#96b5b4;">expect</span><span>(&quot;</span><span style="color:#a3be8c;">form data</span><span>&quot;);
</span><span>	</span><span style="color:#bf616a;">self</span><span>.names.</span><span style="color:#96b5b4;">push</span><span>(format!(
</span><span>	    &quot;</span><span style="color:#d08770;">{} {}</span><span>&quot;,
</span><span>	    form_data.</span><span style="color:#96b5b4;">get</span><span>(&quot;</span><span style="color:#a3be8c;">first</span><span>&quot;).</span><span style="color:#96b5b4;">as_string</span><span>().</span><span style="color:#96b5b4;">unwrap</span><span>(),
</span><span>	    form_data.</span><span style="color:#96b5b4;">get</span><span>(&quot;</span><span style="color:#a3be8c;">last</span><span>&quot;).</span><span style="color:#96b5b4;">as_string</span><span>().</span><span style="color:#96b5b4;">unwrap</span><span>()
</span><span>));
</span><span>...
</span><span style="color:#65737e;">//yes this is still actually a rust file, not html. Yew does some funky with a macro for handling inline html nodes
</span><span>html! {
</span><span>	&lt;form onsubmit={ctx.</span><span style="color:#96b5b4;">link</span><span>().</span><span style="color:#96b5b4;">callback</span><span>(Msg::Submit)}&gt;
</span><span>	    &lt;label&gt;{&quot;</span><span style="color:#a3be8c;">Sign up</span><span>&quot;}&lt;/label&gt;
</span><span>	    &lt;input name=&quot;</span><span style="color:#a3be8c;">first</span><span>&quot; placeholder=&quot;</span><span style="color:#a3be8c;">First name</span><span>&quot;/&gt;
</span><span>	    &lt;input name=&quot;</span><span style="color:#a3be8c;">last</span><span>&quot; placeholder=&quot;</span><span style="color:#a3be8c;">Last name</span><span>&quot;/&gt;
</span><span>	    &lt;input </span><span style="color:#b48ead;">type</span><span>=&quot;</span><span style="color:#a3be8c;">submit</span><span>&quot;/&gt;
</span><span>	&lt;/form&gt;
</span></code></pre>
<p>To keep things snappy, web-sys makes heavy use of features/conditional compilation. Make sure to include the ones you need (other examples may use additionl features, check the linked PRs or the repo for full details).</p>
<pre data-lang="toml" style="background-color:#2b303b;color:#c0c5ce;" class="language-toml "><code class="language-toml" data-lang="toml"><span>[dependencies.web-sys]
</span><span style="color:#bf616a;">version </span><span>= &quot;</span><span style="color:#a3be8c;">0.3.69</span><span>&quot;
</span><span style="color:#bf616a;">features </span><span>= [&quot;</span><span style="color:#a3be8c;">FormData</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">HtmlFormElement</span><span>&quot;]
</span></code></pre>
<h3 id="form-with-file-input-selector-and-callbacks">Form with file input selector and callbacks</h3>
<p>Handling <a href="https://github.com/knzai/yew/pull/2/files">file data from an input in a form</a> gets a bit more complicated on the client side. The browser just stores a reference to the file in that input, so you don't just get immediate access to it. To parse the file data requires starting to deal with more async bridging between <a href="https://rustwasm.github.io/wasm-bindgen/introduction.html">rust, js, and native browser bindings</a>.</p>
<p>At it's core it's still relatively simple, once you understand it and have pared all the fluff off (the original upload example handles drag and drop, which is nice for UX, but gets in the way when going for a simplest base case)</p>
<p>In the form we make a callback for the actual submission, and make another one on the file input directly, so that it can kick-off the file parsing immediately and not wait for entering other data and clicking submit. I actually disable the submit button till that is finished, to simplify the async handling (arguably this too is fluff, but mostly it's here to show the multiple different steps of callbacks/async needed). <code>gloo</code>, well does what it's named for, and sticks a lot of the js_sys and web_sys together in a way that makes it easy for yew (ha!) to deal with (I wonder if yew or gloo came first). In particular <code>gloo::file::FileList::from</code> handles the multiple levels of unwrapping and conversions to get a simple FileList type from the binding of the input, which we can then pass along to our file handling logic.</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">use </span><span>std::collections::HashMap;
</span><span>
</span><span style="color:#b48ead;">use </span><span>base64::{engine::general_purpose::</span><span style="color:#d08770;">STANDARD</span><span>, Engine};
</span><span style="color:#b48ead;">use </span><span>gloo::file::{callbacks::FileReader, File, FileList};
</span><span style="color:#b48ead;">use </span><span>gloo_console::debug;
</span><span style="color:#b48ead;">use </span><span>web_sys::{File as RawFile, FormData, HtmlFormElement, HtmlInputElement};
</span><span style="color:#b48ead;">use </span><span>yew::prelude::*;
</span><span>...
</span><span>html! {
</span><span>&lt;form onsubmit={ctx.</span><span style="color:#96b5b4;">link</span><span>().</span><span style="color:#96b5b4;">callback</span><span>(Msg::Submit)}&gt;
</span><span>    &lt;lable </span><span style="color:#b48ead;">for</span><span>=&quot;</span><span style="color:#a3be8c;">alt-text</span><span>&quot;&gt;{&quot;</span><span style="color:#a3be8c;">Alt Text</span><span>&quot;}&lt;/lable&gt;
</span><span>    &lt;input id=&quot;</span><span style="color:#a3be8c;">alt-text</span><span>&quot; name=&quot;</span><span style="color:#a3be8c;">alt-text</span><span>&quot; /&gt;
</span><span>    &lt;input
</span><span>        id=&quot;</span><span style="color:#a3be8c;">file</span><span>&quot;
</span><span>        name=&quot;</span><span style="color:#a3be8c;">file</span><span>&quot;
</span><span>        </span><span style="color:#b48ead;">type</span><span>=&quot;</span><span style="color:#a3be8c;">file</span><span>&quot;
</span><span>        accept=&quot;</span><span style="color:#a3be8c;">image/*</span><span>&quot;
</span><span>        multiple={</span><span style="color:#d08770;">false</span><span>}
</span><span>        onchange={ctx.</span><span style="color:#96b5b4;">link</span><span>().</span><span style="color:#96b5b4;">callback</span><span>(</span><span style="color:#b48ead;">move </span><span>|e: Event| {
</span><span>            </span><span style="color:#b48ead;">let</span><span> input: HtmlInputElement = e.</span><span style="color:#96b5b4;">target_unchecked_into</span><span>();
</span><span>            Msg::File(gloo::file::FileList::from(input.</span><span style="color:#96b5b4;">files</span><span>().</span><span style="color:#96b5b4;">expect</span><span>(&quot;</span><span style="color:#a3be8c;">file</span><span>&quot;)))
</span><span>            })}
</span><span>    /&gt;
</span></code></pre>
<p>This is the core of the tricky bits. Again gloo streamlines a lot and <code>gloo::file::callbacks::read_as_bytes</code> handles the async parsing of the file data itself out of the file list. Since this is async and hands back a FileReader, we have to stick that reader somewhere to keep it alive and going, and a hashmap keyed off the filename works fine. When this completes we store the file_data in app state directly as a Vec<byte> (rather than adding more complex transforms back and forth across the bindgens and sticking it in a form input), reenable submit, and unref the reader closure from our hashmap.</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span>Msg::Loaded(name, data) =&gt; {
</span><span>    </span><span style="color:#b48ead;">let</span><span> submit = </span><span style="color:#bf616a;">self</span><span>.button.cast::&lt;HtmlInputElement&gt;().</span><span style="color:#96b5b4;">expect</span><span>(&quot;</span><span style="color:#a3be8c;">button</span><span>&quot;);
</span><span>    </span><span style="color:#bf616a;">self</span><span>.file_data = data;
</span><span>    submit.</span><span style="color:#96b5b4;">set_disabled</span><span>(</span><span style="color:#d08770;">false</span><span>);
</span><span>    </span><span style="color:#bf616a;">self</span><span>.readers.</span><span style="color:#96b5b4;">remove</span><span>(&amp;name);
</span><span>}
</span><span>Msg::File(files) =&gt; {
</span><span>    </span><span style="color:#b48ead;">let</span><span> submit = </span><span style="color:#bf616a;">self</span><span>.button.cast::&lt;HtmlInputElement&gt;().</span><span style="color:#96b5b4;">expect</span><span>(&quot;</span><span style="color:#a3be8c;">button</span><span>&quot;);
</span><span>    submit.</span><span style="color:#96b5b4;">set_disabled</span><span>(</span><span style="color:#d08770;">true</span><span>);
</span><span>
</span><span>    </span><span style="color:#b48ead;">let</span><span> file = files[</span><span style="color:#d08770;">0</span><span>].</span><span style="color:#96b5b4;">clone</span><span>();
</span><span>    </span><span style="color:#b48ead;">let</span><span> link = ctx.</span><span style="color:#96b5b4;">link</span><span>().</span><span style="color:#96b5b4;">clone</span><span>();
</span><span>    </span><span style="color:#b48ead;">let</span><span> name = file.</span><span style="color:#96b5b4;">name</span><span>().</span><span style="color:#96b5b4;">clone</span><span>();
</span><span>    </span><span style="color:#b48ead;">let</span><span> task = {
</span><span>        gloo::file::callbacks::read_as_bytes(&amp;file, </span><span style="color:#b48ead;">move </span><span>|res| {
</span><span>            link.</span><span style="color:#96b5b4;">send_message</span><span>(Msg::Loaded(name, res.</span><span style="color:#96b5b4;">expect</span><span>(&quot;</span><span style="color:#a3be8c;">failed to read file</span><span>&quot;)));
</span><span>        })
</span><span>    };
</span><span>    </span><span style="color:#bf616a;">self</span><span>.readers.</span><span style="color:#96b5b4;">insert</span><span>(file.</span><span style="color:#96b5b4;">name</span><span>(), task);
</span><span>}
</span></code></pre>
<p>After that our submit logic is mostly just form handling + grabbing our stored file data out of state (resetting that might be unneccessary since it'll just overwrite, but it just seems cleaner, just in case). <code>self.files</code> is just a Vec<FileDetails> we use to iterate over and output the files. Oh maybe that's also interesting, so I'll include that part. It's just the standard approach to writing base64 image data directly into the src attribute.</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span>Msg::Submit(event) =&gt; {
</span><span>    debug!(event.</span><span style="color:#96b5b4;">clone</span><span>()); </span><span style="color:#65737e;">// gloo_console for nice debugging via the browser inspector console
</span><span>    event.</span><span style="color:#96b5b4;">prevent_default</span><span>();
</span><span>    </span><span style="color:#b48ead;">let</span><span> form: HtmlFormElement = event.</span><span style="color:#96b5b4;">target_unchecked_into</span><span>();
</span><span>    </span><span style="color:#b48ead;">let</span><span> form_data = FormData::new_with_form(&amp;form).</span><span style="color:#96b5b4;">expect</span><span>(&quot;</span><span style="color:#a3be8c;">form data</span><span>&quot;);
</span><span>    </span><span style="color:#b48ead;">let</span><span> image_file = File::from(RawFile::from(form_data.</span><span style="color:#96b5b4;">get</span><span>(&quot;</span><span style="color:#a3be8c;">file</span><span>&quot;)));
</span><span>
</span><span>    </span><span style="color:#b48ead;">let</span><span> alt_text = form_data.</span><span style="color:#96b5b4;">get</span><span>(&quot;</span><span style="color:#a3be8c;">alt-text</span><span>&quot;).</span><span style="color:#96b5b4;">as_string</span><span>().</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>    </span><span style="color:#b48ead;">let</span><span> name = image_file.</span><span style="color:#96b5b4;">name</span><span>();
</span><span>    </span><span style="color:#b48ead;">let</span><span> data = </span><span style="color:#bf616a;">self</span><span>.file_data.</span><span style="color:#96b5b4;">clone</span><span>();
</span><span>
</span><span>    </span><span style="color:#b48ead;">let</span><span> file_type = image_file.</span><span style="color:#96b5b4;">raw_mime_type</span><span>();
</span><span>    </span><span style="color:#bf616a;">self</span><span>.files.</span><span style="color:#96b5b4;">push</span><span>(FileDetails {
</span><span>        alt_text,
</span><span>        name,
</span><span>        data,
</span><span>        file_type,
</span><span>    });
</span><span>    </span><span style="color:#bf616a;">self</span><span>.file_data = Vec::default();
</span><span>}
</span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">view_file</span><span>(</span><span style="color:#bf616a;">file</span><span>: &amp;FileDetails) -&gt; Html {
</span><span>    </span><span style="color:#b48ead;">let</span><span> src = format!(
</span><span>        &quot;</span><span style="color:#a3be8c;">data:</span><span style="color:#d08770;">{}</span><span style="color:#a3be8c;">;base64,</span><span style="color:#d08770;">{}</span><span>&quot;,
</span><span>        file.file_type,
</span><span>        </span><span style="color:#d08770;">STANDARD</span><span>.</span><span style="color:#96b5b4;">encode</span><span>(&amp;file.data)
</span><span>    );
</span><span>    html! {
</span><span>        &lt;div class=&quot;</span><span style="color:#a3be8c;">preview-tile</span><span>&quot;&gt;
</span><span>            &lt;p class=&quot;</span><span style="color:#a3be8c;">preview-name</span><span>&quot;&gt;{ format!(&quot;</span><span style="color:#d08770;">{}</span><span>&quot;, file.name) }&lt;/p&gt;
</span><span>            &lt;div class=&quot;</span><span style="color:#a3be8c;">preview-media</span><span>&quot;&gt;
</span><span>                &lt;img src={src} alt={file.alt_text.</span><span style="color:#96b5b4;">clone</span><span>()}/&gt;
</span><span>            &lt;/div&gt;
</span><span>        &lt;/div&gt;
</span><span>    }
</span><span>}
</span><span>
</span></code></pre>

  
</div>

      </div>
    </body>
</html>
