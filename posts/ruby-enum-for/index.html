<!DOCTYPE html>
<html lang="en">
    <head>
      <title>Kenzi Connor: Using Ruby enum_for to implement multiple paths enumerating the same Enumerable</title>
<meta name="description" content="Idiomatic breadth-frist versus depth-first tree-traversals in Ruby">

<!-- Open Graph Tiles -->
<meta property="og:title" content="Kenzi Connor: Using Ruby enum_for to implement multiple paths enumerating the same Enumerable">
<meta property="og:description" content="Idiomatic breadth-frist versus depth-first tree-traversals in Ruby">
<meta property="og:image" content="https://knz.ai/posts/ruby-enum-for.png" />
<meta name="twitter:title" content="Kenzi Connor: Using Ruby enum_for to implement multiple paths enumerating the same Enumerable">
<meta name="twitter:description" content="Idiomatic breadth-frist versus depth-first tree-traversals in Ruby">
<meta name="twitter:image" content="https://knz.ai/posts/ruby-enum-for.png">

<!-- Open Graph Tiles; static -->
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@knzconnor" />
<meta name="twitter:creator" content="@knzconnor" />
<meta property="twitter:domain" content="knz.ai">

<!-- General meta -->
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<!-- Enable responsiveness on mobile devices-->
<!-- viewport-fit=cover is to support iPhone X rounded corners and notch in landscape-->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, viewport-fit=cover">
      
  <link rel="icon" href="/assets/images/walle-female.svg">

<!-- CSS -->
<link rel="stylesheet" href="https://knz.ai/print.css" media="print">
<link rel="stylesheet" href="https://knz.ai/poole.css">
<link rel="stylesheet" href="https://knz.ai/hyde.css">
<link rel="stylesheet" href="https://knz.ai/styles.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
      <link rel="alternate" type="application/atom+xml" title="Kenzi Connor Atom Feed" href="https://knz.ai/atom.xml" />
      <link rel="alternate" type="application/rss+xml" title="Kenzi Connor RSS Feed" href="https://knz.ai/rss.xml" />
    </head>
    <body class="theme-base-08 layout-reverse">
      <div class="sidebar">
        
          <div class="container sidebar-sticky">
  <ul class="sidebar-nav">
    <li class="sidebar-nav-item active">posts</li><li class="sidebar-nav-item">
      <a href="https:&#x2F;&#x2F;knz.ai&#x2F;projects&#x2F;" class=>projects</a></li><li class="sidebar-nav-item">
      <a href="https:&#x2F;&#x2F;knz.ai&#x2F;about&#x2F;" class=>about</a></li>
  <li class="sidebar-nav-item">
      <a href="https:&#x2F;&#x2F;knz.ai&#x2F;resume&#x2F;" class=>resume</a></li>

</ul>
  <div class="sidebar-about">
    
        <a href="https:&#x2F;&#x2F;knz.ai"><h1>Kenzi Connor</h1></a>
        
        <p class="lead">Staff Software Engineer - VP Engineering - Director of Engineering - CEO &amp; CTO</p>
        
    
  </div>
  <ul class="sidebar-nav">
      
      <li class="sidebar-nav-item"><a rel="me" href="https:&#x2F;&#x2F;github.com&#x2F;knzai">GitHub</a></li>
      
      <li class="sidebar-nav-item"><a rel="me" href="https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;knzai&#x2F;">LinkedIn</a></li>
      
      <li class="sidebar-nav-item"><a rel="me" href="mailto:site@knz.ai">site@knz.ai</a></li>
      
      <li class="sidebar-nav-item"><a rel="me" href="https:&#x2F;&#x2F;tech.lgbt&#x2F;@knzai">Mastadon</a></li>
      
  </ul>
</div>
        
      </div>
      <div class="content container">
        
	
<div class="breadcrumb-container">
    
    
      
      
        <a class="breadcrumb-path" href="https:&#x2F;&#x2F;knz.ai&#x2F;">knz.ai</a>
      
      <span class="breadcrumb-separator">></span>
    
      
      
        <a class="breadcrumb-path" href="https:&#x2F;&#x2F;knz.ai&#x2F;posts&#x2F;">posts</a>
      
      <span class="breadcrumb-separator">></span>
    
    
    
      ruby-enum-for
    
</div>


	<div class="post ruby-enum-for">
  
  
  <h2 class="post-title">
    <a href="https:&#x2F;&#x2F;knz.ai&#x2F;posts&#x2F;ruby-enum-for&#x2F;" id="Using Ruby enum_for to implement multiple paths enumerating the same Enumerable">Using Ruby enum_for to implement multiple paths enumerating the same Enumerable</a>: <span class="post-description">Idiomatic breadth-frist versus depth-first tree-traversals in Ruby</span>
  </h2>

  <span class="post-date">2024-07-28</span>
  
    <p>Anyone who as gotten very far in a basic "implement this data structure" tech-screen, using Ruby, hopefully knows about just making your <a href="https://blog.appsignal.com/2018/05/29/ruby-magic-enumerable-and-enumerator.html">class an <code>Enumerable</code> and implementing <code>#each</code></a> to get all of the methods of that Mixin, which people are used to using on collections in any Ruby project. Less obvious is how you tackle a more complex case, like trees (another interview classic), which have different possible traversal methods of even the same instance.</p>
<p>In this post I'll show how to use enum_for to make an interface for a Tree class that supports these different styles of usage for traversals:</p>
<pre data-lang="ruby" style="background-color:#2b303b;color:#c0c5ce;" class="language-ruby "><code class="language-ruby" data-lang="ruby"><span>@</span><span style="color:#bf616a;">tree </span><span>= </span><span style="color:#ebcb8b;">Tree</span><span>.</span><span style="color:#8fa1b3;">new</span><span>(</span><span style="color:#d08770;">1</span><span>, </span><span style="color:#ebcb8b;">Tree</span><span>.</span><span style="color:#8fa1b3;">new</span><span>(</span><span style="color:#d08770;">2</span><span>, </span><span style="color:#ebcb8b;">Tree</span><span>.</span><span style="color:#8fa1b3;">new</span><span>(</span><span style="color:#d08770;">4</span><span>, </span><span style="color:#d08770;">8</span><span>), </span><span style="color:#d08770;">5</span><span>), </span><span style="color:#ebcb8b;">Tree</span><span>.</span><span style="color:#8fa1b3;">new</span><span>(</span><span style="color:#d08770;">3</span><span>, </span><span style="color:#d08770;">6</span><span>, </span><span style="color:#d08770;">7</span><span>))
</span><span>
</span><span>depth = [</span><span style="color:#d08770;">1</span><span>, </span><span style="color:#d08770;">2</span><span>, </span><span style="color:#d08770;">4</span><span>, </span><span style="color:#d08770;">8</span><span>, </span><span style="color:#d08770;">5</span><span>, </span><span style="color:#d08770;">3</span><span>, </span><span style="color:#d08770;">6</span><span>, </span><span style="color:#d08770;">7</span><span>]
</span><span>assert_equal depth, @</span><span style="color:#bf616a;">tree</span><span>.map(&amp;</span><span style="color:#a3be8c;">:value</span><span>)
</span><span>assert_equal depth, @</span><span style="color:#bf616a;">tree</span><span>.each.map(&amp;</span><span style="color:#a3be8c;">:value</span><span>)
</span><span>assert_equal depth, @</span><span style="color:#bf616a;">tree</span><span>.each(</span><span style="color:#a3be8c;">:depth</span><span>).map(&amp;</span><span style="color:#a3be8c;">:value</span><span>)
</span><span>
</span><span>breadth = [</span><span style="color:#d08770;">1</span><span>, </span><span style="color:#d08770;">2</span><span>, </span><span style="color:#d08770;">3</span><span>, </span><span style="color:#d08770;">4</span><span>, </span><span style="color:#d08770;">5</span><span>, </span><span style="color:#d08770;">6</span><span>, </span><span style="color:#d08770;">7</span><span>, </span><span style="color:#d08770;">8</span><span>]
</span><span>assert_equal breadth, @</span><span style="color:#bf616a;">tree</span><span>.breadth.map(&amp;</span><span style="color:#a3be8c;">:value</span><span>)
</span><span>assert_equal breadth, @</span><span style="color:#bf616a;">tree</span><span>.each(</span><span style="color:#a3be8c;">:breadth</span><span>).map(&amp;</span><span style="color:#a3be8c;">:value</span><span>)
</span></code></pre>
<span id="continue-reading"></span>
<p>I've given the LinkedList version of a tech screen enough times (before I decided the flaws in thos whole approach outweigh the gains, but that's a longer topic for another post) I could probably implement it in my sleep. Since I've been working on learning Rust, I practiced some list implementations in that. This was excellent didactic experience (I learned so much more about <code>Option</code> and why I really do like Rust), but it definitely highlighted that I don't have the 20 years experience in Rust that I do in Ruby.</p>
<p>Whipping out a LinkedList to reminded myself that yes, I still know Ruby very well (it descended into golfing, and then this slightly silly implementation of <code>#shift</code> that I'd never do outside a gag: <code>l,s = reverse_each.first(2); l.h.tap { l.h = s&amp;.t = nil })</code>. I figured I should do tree traversals as well, since breadth-first did trip me up in an interview once (I choked and couldn't recall "just put it in a stack", which I have since tattoed into my brain).</p>
<p>The interesting part is right here:</p>
<pre data-lang="ruby" style="background-color:#2b303b;color:#c0c5ce;" class="language-ruby "><code class="language-ruby" data-lang="ruby"><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">each</span><span>(</span><span style="color:#bf616a;">traversal</span><span>=</span><span style="color:#a3be8c;">:depth</span><span>, &amp;</span><span style="color:#bf616a;">block</span><span>)
</span><span>  </span><span style="color:#b48ead;">case</span><span> traversal
</span><span>  </span><span style="color:#b48ead;">when </span><span style="color:#a3be8c;">:depth
</span><span>    depth(&amp;block)
</span><span>  </span><span style="color:#b48ead;">when </span><span style="color:#a3be8c;">:breadth
</span><span>    breadth(&amp;block)
</span><span>  </span><span style="color:#b48ead;">else
</span><span>    </span><span style="color:#8fa1b3;">raise </span><span>&quot;</span><span style="color:#a3be8c;">Why don&#39;t *you* implement </span><span>#{traversal}</span><span style="color:#a3be8c;"> traversal</span><span>&quot;
</span><span>  </span><span style="color:#b48ead;">end
</span><span style="color:#b48ead;">end
</span><span>
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">depth</span><span>(&amp;</span><span style="color:#bf616a;">block</span><span>)
</span><span>  </span><span style="color:#b48ead;">return </span><span style="color:#96b5b4;">enum_for</span><span>(</span><span style="color:#a3be8c;">:depth</span><span>) </span><span style="color:#b48ead;">unless block_given?
</span><span>  </span><span style="color:#b48ead;">yield </span><span style="color:#bf616a;">self
</span><span>  children.each { |</span><span style="color:#bf616a;">c</span><span>| c.each(&amp;block) }
</span><span style="color:#b48ead;">end
</span><span>
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">breadth
</span><span>  </span><span style="color:#b48ead;">return </span><span style="color:#96b5b4;">enum_for</span><span>(</span><span style="color:#a3be8c;">:breadth</span><span>) </span><span style="color:#b48ead;">unless block_given?
</span><span>  stack = [</span><span style="color:#bf616a;">self</span><span>]
</span><span>  </span><span style="color:#b48ead;">while</span><span> current = stack.shift </span><span style="color:#b48ead;">do 
</span><span>    </span><span style="color:#b48ead;">yield</span><span> current
</span><span>    stack.push *current.children
</span><span>  </span><span style="color:#b48ead;">end
</span><span style="color:#b48ead;">end
</span></code></pre>
<p>By returning an <a href="https://ruby-doc.org/core-2.6/Enumerator.html">Enumerator</a> from your arbitrarily named (unlike implementing <code>Enumerable</code> via <code>#each</code>) traversal methods, you allow them to be chained as usual with <code>#map</code> (or any of the other similar methods). And you can then just call these methods directly from your <code>#each</code> implementation, making the enumerable methods work when called directly on an instance of the class (defaulting to depth).</p>
<p>Oh also make sure to deref/splat the children into your stack on breadth, so you don't mutate the children list directly. I didn't catch that till I added the tests to make sure you could repeat traversals safely. Which shows that tests are nice. Rust definitely would have made all this trickier... but in return would have caught that upfront.</p>
<p>In case it's of interest, here's the rest of the basic class:</p>
<pre data-lang="ruby" style="background-color:#2b303b;color:#c0c5ce;" class="language-ruby "><code class="language-ruby" data-lang="ruby"><span style="color:#65737e;">#how inspect looks, from a test. I think I need to tweak it a bit more to make it more intuitive.
</span><span>assert_equal &quot;</span><span style="color:#a3be8c;">1: [2: [4: [8], 5], 3: [6, 7]]</span><span>&quot;, @</span><span style="color:#bf616a;">tree</span><span>.</span><span style="color:#96b5b4;">inspect
</span><span>
</span><span style="color:#65737e;">#the thing itself
</span><span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">Tree
</span><span style="color:#eff1f5;">  </span><span style="color:#8fa1b3;">include </span><span style="color:#bf616a;">Enumerable
</span><span>
</span><span>  </span><span style="color:#8fa1b3;">attr_accessor </span><span style="color:#a3be8c;">:children</span><span>, </span><span style="color:#a3be8c;">:value
</span><span>
</span><span>  </span><span style="color:#b48ead;">def </span><span style="color:#bf616a;">self</span><span>.</span><span style="color:#8fa1b3;">new</span><span>(</span><span style="color:#bf616a;">value</span><span>, *</span><span style="color:#bf616a;">children</span><span>)
</span><span>    value.</span><span style="color:#96b5b4;">is_a?</span><span>(</span><span style="color:#bf616a;">Tree</span><span>) ? value : </span><span style="color:#b48ead;">super</span><span>(value, *children)
</span><span>  </span><span style="color:#b48ead;">end
</span><span>
</span><span>  </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">initialize</span><span>(</span><span style="color:#bf616a;">value</span><span>, *</span><span style="color:#bf616a;">children</span><span>)
</span><span>    @</span><span style="color:#bf616a;">children </span><span>= *children.map { |</span><span style="color:#bf616a;">c</span><span>| </span><span style="color:#ebcb8b;">Tree</span><span>.</span><span style="color:#8fa1b3;">new</span><span>(c) }
</span><span>    @</span><span style="color:#bf616a;">value </span><span>= value
</span><span>  </span><span style="color:#b48ead;">end
</span><span>
</span><span>  </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">inspect
</span><span>    </span><span style="color:#b48ead;">if</span><span> children.empty?
</span><span>      value.</span><span style="color:#96b5b4;">to_s
</span><span>    </span><span style="color:#b48ead;">else
</span><span>      &quot;#{value}</span><span style="color:#a3be8c;">: [</span><span>#{children.map(&amp;</span><span style="color:#a3be8c;">:inspect</span><span>).join(&#39;</span><span style="color:#a3be8c;">, </span><span>&#39;)}</span><span style="color:#a3be8c;">]</span><span>&quot;
</span><span>    </span><span style="color:#b48ead;">end
</span><span>  </span><span style="color:#b48ead;">end
</span></code></pre>
<p>By overloading <code>#new</code> to either make a new Tree (and call <code>#super</code>, of course, don't skip your <code>#allocate</code>) or just pass along the existing one, we make trival the test setup in the first code block that just passes the nested trees in directly as children, as well as the literal values. Oh and *splat the children again, of course, this time so you can pass in an arbitrary amount.</p>

  
</div>

      </div>
    </body>
</html>
